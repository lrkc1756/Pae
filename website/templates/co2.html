<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Manager</title>
    <!-- Add Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .project-name.editable {
            cursor: text;
        }
        .edit-input {
            flex-grow: 1;
            border: 1px solid #ccc;
            padding: 3px;
            margin-right: 5px;
            font-family: inherit;
            font-size: inherit;
        }

        .project-item .sub-list .sub-list .add-btn {
            display: none;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            font-family: Arial, sans-serif;
            background-color: #006400;
            color: white;
        }
        #sidebar {
            width: 300px;
            height: 100vh;
            background-color: #004d00;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
            position: fixed;
            left: 0;
            top: 0;
        }
        .sidebar-header {
            padding: 20px 20px 10px;
            background: #003300;
            border-bottom: 1px solid #004d00;
            display: flex;
            justify-content: center;
        }
        
        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px 20px;
            background-color: #004d00;
        }
        
        .sidebar-footer {
            padding: 10px 20px 20px;
            background: #003300;
            border-top: 1px solid #004d00;
        }
        .project-list {
            list-style: none;
            padding-left: 0;
        }
        .project-item {
            margin: 5px 0;
            position: relative;
        }
        .project-content {
            display: flex;
            align-items: center;
            padding: 5px;
            background-color: #2a852a !important;
            border-radius: 3px;
        }
        .project-name {
            flex-grow: 1;
        }
        .sub-list {
            padding-left: 20px;
            display: none;
        }
        .btn {
            cursor: pointer;
            margin-left: 5px;
            padding: 2px 5px;
            background-color: #98FB98 !important;
            border: none;
            border-radius: 3px;
            color: #333;
        }
        .btn:hover {
            background-color: #7CFC00 !important;
        }
        #input-section {
            margin-top: 20px;
        }

        .input-group {
            margin-bottom: 15px;
            width: 100%;
            max-width: 400px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
        }

        .input-group input {
            width: 200px;
            padding: 5px;
            background-color: #004d00;
            color: white; 
            border: 1px solid #98FB98;
        }
        .input-group input, 
        .input-group select {
            width: 100%;
        }
        .error {
            color: red;
            font-size: 0.9em;
        }

        .emission-badge {
            background: #005a00;
            padding: 3px 8px;
            border-radius: 3px;
            margin-left: 10px;
        }

        .total-emission {
            background: #004d00;;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .total-emission p {
            margin: 8px 0;
            font-size: 16px;
        }

        select {
            width: 220px;
            padding: 5px;
            border: 1px solid #98FB98;
            border-radius: 3px;
            background-color: #004d00;
            color: white;
        }
        .edit-input{
            background-color: #004d00;
            color: white;
            border-color: #98FB98;
        }

        .image-container {
            display: flex;
            justify-content: flex-end;
            gap: 20px;
            margin-top: 20px;
            padding: 20px 0;
            width: 100%;
        }

        .DRV-img {
            height: 50px;
            width: auto;
            object-fit: contain;
        }

        .UCB-img {
            height: 50px;
            width: auto;
            object-fit: contain;
        }
        .PAE-img {
            height: 50px;
            width: auto;
            object-fit: contain;
        }
        #content-area {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 20px;
            margin-left: 300px;
            justify-content: center;
            align-items: center;
            height: 100%;
        }

        #project-header {
            order: 1;
            margin-bottom: 20px;
        }

        #input-section {
            order: 2;
            margin-bottom: 20px;
        }

        #output-section {
            order: 3;
            flex-grow: 1;
            width: 100%;
            max-width: 800px;
        }

        .image-container {
            order: 4;
            margin-top: auto;
            padding-top: 20px;
        }

        #total-emissions-display {
            border: 1px solid #005a00;
            text-align: center;
            cursor: pointer;
        }
        
        #all-projects-total {
            color: #98FB98;
            font-size: 1.2em;
        }
        
        /* 新增样式 */
        .custom-input-container {
            display: flex;
            margin-top: 5px;
        }
        .custom-input {
            flex-grow: 1;
            padding: 5px;
            background-color: #004d00;
            color: white;
            border: 1px solid #98FB98;
            border-radius: 3px 0 0 3px;
        }
        .add-custom-btn {
            padding: 5px 10px;
            background-color: #98FB98;
            border: none;
            border-radius: 0 3px 3px 0;
            cursor: pointer;
        }

        /* Chart container styles */
        .chart-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
            justify-content: center;
        }

        .chart-wrapper {
            width: 100%;
            max-width: 400px;
            background: #004d00;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .chart-title {
            text-align: center;
            margin-bottom: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="sidebar-header">
            <h2>MyProject</h2>
        </div>
        <div class="scrollable-content">
            <ul class="project-list" id="main-list">
            <li class="project-item"  id="example-project">
                <div class="project-content">
                    <span class="project-name editable">Example Project</span>
                    <button class="btn add-btn">+</button>
                    <button class="btn delete-btn">×</button>
                </div>
            </li>
        </ul>
        </div>
        <div class="sidebar-footer">
            <div id="total-emissions-display" style="padding: 10px; background: #003300; margin-bottom: 10px; border-radius: 3px;">
                <h3 style="margin-top: 0; margin-bottom: 5px;">Total CO₂ Emissions</h3>
                <div id="all-projects-total" style="font-size: 18px; font-weight: bold;">0.00 g</div>
            </div>
            <button id="add-main-btn">Add project</button>
        </div>
    </div>
    <div id="content-area" style="margin-left: 300px; padding: 20px;">
        <div id="project-header" style="margin-bottom: 20px;">
            <h2 id="selected-project" style="text-align: center;"></h2>
        </div>
        <div id="input-section" style="margin-bottom: 20px;"></div>
        <div id="output-section"></div>
        <div class="image-container">
            <img src="PAE-e-green.png" alt="PAE-e-green" class="PAE-img">
            <img src="DRV.png" alt="DRV" class="DRV-img">
            <img src="UCB.png" alt="UCB" class="UCB-img">
        </div>
    </div>
    <script>
        const subItems = [
                    'welding',
                    'drying',
                    'assembly of a car door'
                ];

        const DEFAULT_SUB_ITEMS = {
            'welding': [
                'floor assembly',
                'side parts', 
                'rear vehicle',
                'front vehicle',
                'roof structure',
                'door frames',
                'final assembly'
            ],
            'drying': [
                'preheating',
                'interim drying',
                'prime coat drying',
                'topcoat drying',
                'clear drying',
                'final drying',
                'cooling'
            ],
            'assembly of a car door': [
                'positioning and fixing',
                'welding in assembly',
                'bonding',
                'mechanical fastening',
                'sealing installation',
                'installation of electrical components'
            ]
        };

        // 存储自定义选项
        const customOptions = {
            materials: ['welding rod', 'electrodes', 'fluxes', 'coolants'],
            rawMaterials: ['aluminium', 'steel', 'plastics', 'electrical components', 'glass', 'composite materials'],
            additionalMaterials: ['screws', 'adhesives', 'seals', 'lubricants']
        };

        function createDefaultSubItems(parentItem) {
            const subList = document.createElement('ul');
            subList.className = 'sub-list';
            parentItem.appendChild(subList);
            subItems.forEach(item => {
                const subItem = createProjectItem(item);
                subList.appendChild(subItem);
            });

            subList.style.display = 'block';
        }

        function setupRenaming(element) {
            element.addEventListener('dblclick', function(e) {
                if (e.target.classList.contains('editable')) {
                    startRenaming(e.target);
                }
            });
        }

        function startRenaming(nameElement) {
            const input = document.createElement('input');
            input.className = 'edit-input';
            input.value = nameElement.textContent;
            
            const originalDisplay = nameElement.style.display;
            nameElement.style.display = 'none';
            nameElement.parentElement.insertBefore(input, nameElement);
            
            input.focus();
            
            input.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    finishRenaming(input, nameElement);
                }
                if (e.key === 'Escape') {
                    cancelRenaming(input, nameElement, originalDisplay);
                }
            });
            
            input.addEventListener('blur', function() {
                finishRenaming(input, nameElement);
            });
        }

        function finishRenaming(input, nameElement) {
            nameElement.textContent = input.value;
            nameElement.style.display = 'block';
            input.remove();
        }

        function cancelRenaming(input, nameElement, originalDisplay) {
            nameElement.style.display = originalDisplay;
            input.remove();
        }

        function createNestedItems(parentItem, items, isMainProject = false) {
            const subList = document.createElement('ul');
            subList.className = 'sub-list';
            parentItem.appendChild(subList);

            items.forEach(item => {
                const subItem = createProjectItem(item.name || item);
                subList.appendChild(subItem);
                
                if (typeof item === 'object') {
                    createNestedItems(subItem, item.children);
                } else if (DEFAULT_SUB_ITEMS[item] && !isMainProject) {
                    createNestedItems(subItem, DEFAULT_SUB_ITEMS[item]);
                }
            });

            //subList.style.display = 'block';
        }
        
        function createProjectItem(name) {
            const li = document.createElement('li');
            li.className = 'project-item';
            li.dataset.projectId = crypto.randomUUID();
            
            const div = document.createElement('div');
            div.className = 'project-content';
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'project-name editable';
            nameSpan.textContent = name;
            setupRenaming(nameSpan);
            
            const addBtn = document.createElement('button');
            addBtn.className = 'btn add-btn';
            addBtn.textContent = '+';
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn delete-btn';
            deleteBtn.textContent = '×';
            
            div.appendChild(nameSpan);
            div.appendChild(addBtn);
            div.appendChild(deleteBtn);
            li.appendChild(div);
            
            return li;
        }

        function getNestingLevel(item) {
            let level = 0;
            let parentList = item.closest('.sub-list');
            while (parentList) {
                level++;
                parentList = parentList.parentElement.closest('.sub-list');
            }
            return level;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const exampleProject = document.getElementById('example-project');
            createNestedItems(exampleProject, [
                { name: 'welding', children: DEFAULT_SUB_ITEMS.welding },
                { name: 'drying', children: DEFAULT_SUB_ITEMS.drying },
                { name: 'assembly of a car door', children: DEFAULT_SUB_ITEMS['assembly of a car door'] }
            ], true);
            updateAllProjectsTotal();
        });

        document.getElementById('add-main-btn').addEventListener('click', function() {
            const newItem = createProjectItem('New Projects');
            document.getElementById('main-list').appendChild(newItem);
            updateAllProjectsTotal();
            createNestedItems(newItem, [
                'welding',
                'drying',
                'assembly of a car door'
            ]);
        });

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('add-btn')) {
                const parentItem = e.target.closest('.project-item');
                const currentLevel = getNestingLevel(parentItem);
                
                if (currentLevel >= 2) return;
                
                const subList = parentItem.querySelector('.sub-list');
                if (!subList) {
                    const newSubList = document.createElement('ul');
                    newSubList.className = 'sub-list';
                    parentItem.appendChild(newSubList);
                }
                
                const newItem = createProjectItem('New produktion process');
                parentItem.querySelector('.sub-list').appendChild(newItem);
                parentItem.querySelector('.sub-list').style.display = 'block';
            }
            
            if (e.target.classList.contains('delete-btn')) {
                const itemToDelete = e.target.closest('.project-item');
                itemToDelete.remove();
                updateAllProjectsTotal();
            }
            
            if (e.target.classList.contains('project-name')) {
                const subList = e.target.closest('.project-item').querySelector('.sub-list');
                if (subList) {
                    subList.style.display = subList.style.display === 'none' ? 'block' : 'none';
                }
            }
        });

        setupRenaming(document.querySelector('.project-name'));
        const projectData = new Map();
        let currentSubSubItem = null;

        const ENERGY_FACTORS = {
            'Fossil': 1000,
            'Nuclear': 5,
            'Renewable': 0
        };

        document.addEventListener('click', function(e) {
            if (e.target.closest('.project-item')) {
                const item = e.target.closest('.project-item');
                const level = getNestingLevel(item);
            
                document.querySelectorAll('.project-item').forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
                document.getElementById('selected-project').textContent = item.querySelector('.project-name').textContent;
            
                if (level === 2) {
                    currentSubSubItem = item;
                    showInputForm(item);
                
                    const parentProject = item.parentElement.parentElement.parentElement;
                    const parentProcess = item.parentElement.parentElement;
                
                    const dataKey = `${parentProject.dataset.projectId}-${parentProcess.dataset.projectId}-${item.dataset.projectId}`;
                
                    if (projectData.has(dataKey)) {
                        showCurrentEmission(projectData.get(dataKey));
                    } else {
                        document.getElementById('output-section').innerHTML = '';
                    }
                } else {
                    currentSubSubItem = null;
                    showTotalEmissions(item, level);
                }
            }
        });

        function showInputForm(item) {
            const parentNameElement = item.parentElement.parentElement.querySelector('.project-name');
            const parentName = parentNameElement ? parentNameElement.textContent.toLowerCase() : '';
            const inputSection = document.getElementById('input-section');
            inputSection.innerHTML = '';
        
            const commonInputs = `
                <div class="input-group">
                    <label>Energy Type:</label>
                    <select id="energy-type">
                        <option value="Fossil">Fossil (⌀ 1.000 g CO2/kWh)</option>
                        <option value="Nuclear">Nuclear (˂5 g CO2/kWh)</option>
                        <option value="Renewable">Renewable (close to 0 g CO2/kWh)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Energy (kWh):</label>
                    <input type="number" id="energy-input" step="0.1">
                    <div class="error" id="energy-error"></div>
                </div>
            `;
            
            let specificInputs = '';
            if (parentName.includes('welding')) {
                specificInputs = `
                    <div class="input-group">
                        <label>Materials:</label>
                        <select id="materials"></select>
                        <div class="custom-input-container">
                            <input type="text" class="custom-input" id="new-material" placeholder="Add new material">
                            <button class="add-custom-btn" onclick="addCustomOption('materials')">+</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Raw Materials:</label>
                        <select id="raw-materials"></select>
                        <div class="custom-input-container">
                            <input type="text" class="custom-input" id="new-raw-material" placeholder="Add new raw material">
                            <button class="add-custom-btn" onclick="addCustomOption('rawMaterials')">+</button>
                        </div>
                    </div>`;
            } 
            else if (parentName.includes('door')) {
                specificInputs = `
                    <div class="input-group">
                        <label>Raw Materials/Body Parts:</label>
                        <select id="raw-materials"></select>
                        <div class="custom-input-container">
                            <input type="text" class="custom-input" id="new-raw-material" placeholder="Add new raw material">
                            <button class="add-custom-btn" onclick="addCustomOption('rawMaterials')">+</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Additional Materials:</label>
                        <select id="additional-materials"></select>
                        <div class="custom-input-container">
                            <input type="text" class="custom-input" id="new-additional-material" placeholder="Add new additional material">
                            <button class="add-custom-btn" onclick="addCustomOption('additionalMaterials')">+</button>
                        </div>
                    </div>`;
            }
        
            inputSection.innerHTML = `
                ${commonInputs}
                ${specificInputs}
                <button id="calculate-btn" style="margin-top: 15px;">Calculate</button>
                <button id="next-btn" style="margin-left: 10px;">Next</button>
            `;
            
            // 填充下拉菜单选项
            if (parentName.includes('welding')) {
                const materialsSelect = document.getElementById('materials');
                const rawMaterialsSelect = document.getElementById('raw-materials');
                
                customOptions.materials.forEach(option => {
                    materialsSelect.add(new Option(option, option));
                });
                
                customOptions.rawMaterials.forEach(option => {
                    rawMaterialsSelect.add(new Option(option, option));
                });
            } 
            else if (parentName.includes('door')) {
                const rawMaterialsSelect = document.getElementById('raw-materials');
                const additionalMaterialsSelect = document.getElementById('additional-materials');
                
                customOptions.rawMaterials.forEach(option => {
                    rawMaterialsSelect.add(new Option(option, option));
                });
                
                customOptions.additionalMaterials.forEach(option => {
                    additionalMaterialsSelect.add(new Option(option, option));
                });
            }
        
            setupInputValidation();
            const parentProject = item.parentElement.parentElement.parentElement;
            const parentProcess = item.parentElement.parentElement;
            const dataKey = `${parentProject.dataset.projectId}-${parentProcess.dataset.projectId}-${item.dataset.projectId}`;

            if (projectData.has(dataKey)) {
                const savedData = projectData.get(dataKey);

                // 填充输入框和下拉菜单的值
                document.getElementById('energy-type').value = savedData.energyType;
                document.getElementById('energy-input').value = savedData.energy;
            
                const materialsElement = document.getElementById('materials');
                const additionalMaterialsElement = document.getElementById('additional-materials');
            
                if (materialsElement && savedData.materials) {
                    materialsElement.value = savedData.materials;
                }
                if (additionalMaterialsElement && savedData.additionalMaterials) {
                    additionalMaterialsElement.value = savedData.additionalMaterials;
                }
            
                showCurrentEmission(savedData);
            } else {
                document.getElementById('energy-type').value = 'Fossil';
                document.getElementById('energy-input').value = '';

                const materialsElement = document.getElementById('materials');
                const additionalMaterialsElement = document.getElementById('additional-materials');
                if (materialsElement) materialsElement.value = customOptions.materials[0]; // 默认值
                if (additionalMaterialsElement) additionalMaterialsElement.value = customOptions.additionalMaterials[0]; // 默认值
            }
        }

        // 添加自定义选项的函数
        function addCustomOption(type) {
            let inputId, selectId;
            
            switch(type) {
                case 'materials':
                    inputId = 'new-material';
                    selectId = 'materials';
                    break;
                case 'rawMaterials':
                    inputId = 'new-raw-material';
                    selectId = 'raw-materials';
                    break;
                case 'additionalMaterials':
                    inputId = 'new-additional-material';
                    selectId = 'additional-materials';
                    break;
                default:
                    return;
            }
            
            const input = document.getElementById(inputId);
            const newOption = input.value.trim();
            
            if (newOption && !customOptions[type].includes(newOption)) {
                customOptions[type].push(newOption);
                
                const select = document.getElementById(selectId);
                select.add(new Option(newOption, newOption));
                select.value = newOption;
                
                input.value = '';
            }
        }

        function setupInputValidation() {
            const energyInput = document.getElementById('energy-input');
            const errorDiv = document.getElementById('energy-error');

            const validate = () => {
                const value = parseFloat(energyInput.value);
                if (value < 0 || isNaN(value)) {
                    errorDiv.textContent = "Please enter a non-negative number";
                    energyInput.style.borderColor = "red";
                } else {
                    errorDiv.textContent = "";
                    energyInput.style.borderColor = "";
                }
            energyInput.addEventListener('input', validate);
            energyInput.addEventListener('change', validate);   
        };
        energyInput.addEventListener('input', validate);
        energyInput.addEventListener('change', validate);

        document.addEventListener('click', function(e) {
            if (e.target.id === 'calculate-btn') {
                calculateEmissions();
            }
        });
        }

        function calculateEmissions() {
            const energyType = document.getElementById('energy-type').value;
            const energy = parseFloat(document.getElementById('energy-input').value);
                
            const parentProject = currentSubSubItem.parentElement.parentElement.parentElement;
            const parentProcess = currentSubSubItem.parentElement.parentElement;
            const dataKey = `${parentProject.dataset.projectId}-${parentProcess.dataset.projectId}-${currentSubSubItem.dataset.projectId}`;
                
            const emissionData = {
                energyType,
                energy,
                CO2: energy * ENERGY_FACTORS[energyType],
                timestamp: new Date().toISOString()
            };
            const materialsElement = document.getElementById('materials');
            const additionalMaterialsElement = document.getElementById('additional-materials');

            if(materialsElement) {
                emissionData.materials = materialsElement.value;
                emissionData.shieldingGas = energy * 0.2;
                emissionData.weldingFume = energy * 0.1;
            }

            if(additionalMaterialsElement) {
                emissionData.additionalMaterials = additionalMaterialsElement.value;
            }

            projectData.set(dataKey, emissionData);
            showCurrentEmission(emissionData);
            updateParentEmissions();
            updateAllProjectsTotal();
        }

        function showCurrentEmission(data) {
            const outputSection = document.getElementById('output-section');
            let html = `<h3>Current emissions data</h3>`;
        
            html += `<p>CO₂: ${(data.CO2 || 0).toFixed(2)} g</p>`;
            
            if(data.shieldingGas) {
                html += `<p>Shielding Gas: ${data.shieldingGas.toFixed(2)} g</p>`;
            }
            if(data.weldingFume) {
                html += `<p>Welding Fume: ${data.weldingFume.toFixed(2)} g</p>`;
            }
            if(data.VOC) {
                html += `<p>VOC: ${data.VOC.toFixed(2)} g</p>`;
            }

            outputSection.innerHTML = html;
        }

        function showTotalEmissions(item, level) {
            const inputSection = document.getElementById('input-section');
            const outputSection = document.getElementById('output-section');
            inputSection.innerHTML = '';
                
            const total = calculateTotalEmissions(item);
            const childrenData = getChildrenData(item);
                
            // 初始化 html 变量
            let html = '';
                
            let title = '';
            if (level === 0) {
                title = 'Total project emissions';
            } else if (level === 1) {
                title = 'Total emissions from produktion process';
            }
            
            // 构建基础HTML内容
            html = `
                <h3>${title}</h3>
                <div class="total-emission">
                    <p>Total CO₂ emissions: <strong>${total.CO2.toFixed(2)} g</strong></p>
                    ${level === 1 ? `
                    <p>Other emissions: <strong>${(total.shieldingGas + total.weldingFume).toFixed(2)} g</strong></p>
                    ` : ''}
                </div>
            `;
            
            const filteredData = {
                labels: [],
                CO2: [],
                shieldingGas: [],
                weldingFume: []
            };
        
            childrenData.labels.forEach((label, index) => {
                if (childrenData.CO2[index] > 0 || 
                    childrenData.shieldingGas[index] > 0 || 
                    childrenData.weldingFume[index] > 0) {
                    filteredData.labels.push(label);
                    filteredData.CO2.push(childrenData.CO2[index]);
                    filteredData.shieldingGas.push(childrenData.shieldingGas[index]);
                    filteredData.weldingFume.push(childrenData.weldingFume[index]);
                }
            });
        
            // 仅当有数据时显示图表
            if (filteredData.labels.length > 0) {
                html += createChartsHTML(filteredData, level);
            }
        
            outputSection.innerHTML = html;
        
            if (filteredData.labels.length > 0) {
                renderCharts(filteredData, level);
            }
        }

        function getChildrenData(item) {
            const data = {
                labels: [],
                CO2: [],
                shieldingGas: [],
                weldingFume: []
            };
        
            const subList = item.querySelector('.sub-list');
            if (subList) {
                subList.querySelectorAll('.project-item').forEach(child => {
                    // 仅处理直接子项目（排除子子项目）
                    if (child.parentElement === subList) {
                        const parentProject = child.parentElement.parentElement.parentElement;
                        const parentProcess = child.parentElement.parentElement;
                        const dataKey = `${parentProject.dataset.projectId}-${parentProcess.dataset.projectId}-${child.dataset.projectId}`;
                    
                        if (projectData.has(dataKey)) {
                            const childData = projectData.get(dataKey);
                            data.labels.push(child.querySelector('.project-name').textContent);
                            data.CO2.push(childData.CO2 || 0);
                            data.shieldingGas.push(childData.shieldingGas || 0);
                            data.weldingFume.push(childData.weldingFume || 0);
                        }
                    }
                });
            }
            return data;
        }

        function createChartsHTML(childrenData, level) {
            return `
                <div class="chart-container">
                    <div class="chart-wrapper">
                        <div class="chart-title">CO₂ Emissions Distribution</div>
                        <canvas id="pieChart"></canvas>
                    </div>
                    <div class="chart-wrapper">
                        <div class="chart-title">Emissions Comparison</div>
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            `;
        }

        function renderCharts(childrenData, level) {
            if (window.pieChart && typeof window.pieChart.destroy === 'function') {
                window.pieChart.destroy();
            }
            if (window.barChart && typeof window.barChart.destroy === 'function') {
                window.barChart.destroy();
            }
        
            // 确保canvas元素存在
            const pieCanvas = document.getElementById('pieChart');
            const barCanvas = document.getElementById('barChart');
            if (!pieCanvas || !barCanvas) return;
        
            // 清除可能存在的旧上下文
            pieCanvas.width = pieCanvas.offsetWidth;
            pieCanvas.height = pieCanvas.offsetHeight;
            barCanvas.width = barCanvas.offsetWidth;
            barCanvas.height = barCanvas.offsetHeight;
            // Pie Chart for CO2 distribution
            const pieCtx = pieCanvas.getContext('2d');
            window.pieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: childrenData.labels,
                    datasets: [{
                        data: childrenData.CO2,
                        backgroundColor: [
                            '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', 
                            '#FFC107', '#FF9800', '#FF5722', '#795548'
                        ],
                        borderColor: '#004d00',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: 'white'
                            }
                        }
                    }
                }
            });

            // Bar Chart for comparing different emission types
            const barCtx = document.getElementById('barChart').getContext('2d');
            window.barChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: childrenData.labels,
                    datasets: [
                        {
                            label: 'CO₂',
                            data: childrenData.CO2,
                            backgroundColor: '#4CAF50'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    }
                }
            });

            // Add shielding gas and welding fume data if we're at level 1 (sub-items)
            if (level === 1) {
                window.barChart.data.datasets.push(
                    {
                        label: 'Shielding Gas',
                        data: childrenData.shieldingGas,
                        backgroundColor: '#8BC34A'
                    },
                    {
                        label: 'Welding Fume',
                        data: childrenData.weldingFume,
                        backgroundColor: '#CDDC39'
                    }
                );
                window.barChart.update();
            }
        }

        function calculateTotalEmissions(item) {
            const total = { CO2: 0, shieldingGas: 0, weldingFume: 0 };
            const subList = item.querySelector('.sub-list');

            if (subList) {
                subList.querySelectorAll('.project-item').forEach(child => {
                    const parentProject = child.parentElement.parentElement.parentElement;
                    const parentProcess = child.parentElement.parentElement;
                    const dataKey = `${parentProject.dataset.projectId}-${parentProcess.dataset.projectId}-${child.dataset.projectId}`;
                
                    if (projectData.has(dataKey)) {
                        const data = projectData.get(dataKey);
                        total.CO2 += data.CO2 || 0;
                        total.shieldingGas += data.shieldingGas || 0;
                        total.weldingFume += data.weldingFume || 0;
                    }
                });
            }
            return total;
        }

        function updateParentEmissions() {
            const currentItem = document.querySelector('.project-item.selected');
            if (currentItem) {
                const level = getNestingLevel(currentItem);
                if (level < 2) {
                    showTotalEmissions(currentItem, level);
                }
            }
        }

        document.addEventListener('click', function(e) {
            if (e.target.id === 'next-btn') {
                const siblings = Array.from(currentSubSubItem.parentElement.children);
                const currentIndex = siblings.indexOf(currentSubSubItem);
                if (currentIndex < siblings.length - 1) {
                    currentSubSubItem.classList.remove('selected');
                    currentSubSubItem = siblings[currentIndex + 1];
                    currentSubSubItem.classList.add('selected');
                    const newProjectName = currentSubSubItem.querySelector('.project-name').textContent;
                    document.getElementById('selected-project').textContent = newProjectName;
                        
                    showInputForm(currentSubSubItem);
                }
            }

            // Handle click on total emissions display
            if (e.target.closest('#total-emissions-display')) {
                const mainList = document.getElementById('main-list');
                const projectsData = {
                    labels: [],
                    CO2: []
                };
            
                mainList.querySelectorAll('.project-item').forEach(project => {
                    if (getNestingLevel(project) === 0) {
                        const total = calculateTotalEmissions(project);
                        if (total.CO2 > 0) {
                            projectsData.labels.push(project.querySelector('.project-name').textContent);
                            projectsData.CO2.push(total.CO2);
                        }
                    }
                });
            
                const outputSection = document.getElementById('output-section');
                let html = `
                    <h3>Total emissions from all projects</h3>
                    <div class="total-emission">
                        <p>Total CO₂ emissions: <strong>${calculateAllProjectsTotal().toFixed(2)} g</strong></p>
                    </div>
                `;
                
                if (projectsData.labels.length > 0) {
                    html += createChartsHTML(projectsData, 0);
                }
            
                outputSection.innerHTML = html;
            
                if (projectsData.labels.length > 0) {
                    renderCharts(projectsData, 0);
                }
            }
        });
        

        function calculateAllProjectsTotal() {
            let total = 0;
            const mainList = document.getElementById('main-list');

            mainList.querySelectorAll('.project-item').forEach(project => {
                total += calculateTotalEmissions(project).CO2;
            });

            return total / 2;
        }

        function updateAllProjectsTotal() {
            const total = calculateAllProjectsTotal();
            document.getElementById('all-projects-total').textContent = `${total.toFixed(2)} g`;
        }
    </script>
</body>
</html>